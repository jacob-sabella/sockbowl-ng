<!-- Main container for the game buzzer interface -->
<div class="game-buzzer-container">

  <!-- Player info card: Shown only if there is an active game session -->
  <mat-card *ngIf="gameSessionObs | async as gameSession" class="player-info-card">
    <mat-card-content class="player-info-content">
      <!-- Display the current player's name -->
      <div class="player-name">{{ gameStateService.getCurrentPlayer()?.name }}</div>
      <!-- Display the name of the team to which the current player belongs -->
      <div class="player-team">{{ gameStateService.getCurrentPlayerTeam()?.teamName }}</div>
    </mat-card-content>
  </mat-card>

  <!-- Buzzer card: Allows players to buzz in during a game -->
  <mat-card class="game-buzzer">
    <mat-card-title>
      <!-- Display the current round number -->
      Buzz in for Round {{ gameSession.currentMatch.currentRound.roundNumber }}
    </mat-card-title>
    <mat-card-content>
      <!-- Active buzz info: Shown if there's a current buzz -->
      <div *ngIf="gameSession.currentMatch.currentRound.currentBuzz" class="active-buzz-info">
        <!-- Display the name of the player and team who have buzzed in -->
        <p>{{ gameStateService.getPlayerNameById(gameSession.currentMatch.currentRound.currentBuzz.playerId) }} (
          {{ gameStateService.getTeamNameById(gameSession.currentMatch.currentRound.currentBuzz.teamId) }})
          has buzzed in
        </p>
      </div>

      <!-- Buzz button: Allows players to buzz in, visibility and state depend on round conditions -->
      <div class="buzz-button-container">
        <button
          *ngIf="gameSession.currentMatch.currentRound.roundState === RoundState.AWAITING_BUZZ ||
          gameSession.currentMatch.currentRound.roundState === RoundState.PROCTOR_READING"
          mat-raised-button
          id="buzz-button"
          (click)="gameStateService.sendPlayerIncomingBuzz()"
          [disabled]="gameStateService.hasCurrentPlayerTeamBuzzed()"
          class="buzz-button">
          <!-- Display appropriate text on the buzz button -->
          {{ getBuzzButtonText() }}
        </button>
      </div>

      <!-- Timer Display -->
      <div *ngIf="gameSession.currentMatch.currentRound.roundState === RoundState.AWAITING_BUZZ" class="timer-display">
        <p>Time remaining: {{ countdown }}</p>
      </div>

      <!-- Bonus Display -->
      <div *ngIf="gameSession.currentMatch.currentRound.roundState === RoundState.BONUS_READING_PREAMBLE ||
                  gameSession.currentMatch.currentRound.roundState === RoundState.BONUS_READING_PART ||
                  gameSession.currentMatch.currentRound.roundState === RoundState.BONUS_AWAITING_ANSWER ||
                  gameSession.currentMatch.currentRound.roundState === RoundState.BONUS_COMPLETED"
           class="bonus-section">

        <div class="bonus-header">
          <h3>Bonus for {{ getBonusEligibleTeamName() }}</h3>
          <div class="bonus-score">
            {{ gameStateService.getCurrentRoundBonusPoints() }} / 30 points
          </div>
        </div>

        <!-- PREAMBLE PHASE -->
        <div *ngIf="gameSession.currentMatch.currentRound.roundState === RoundState.BONUS_READING_PREAMBLE">
          <div class="bonus-preamble-section">
            <h4>Preamble</h4>
            <div class="bonus-preamble" [innerHTML]="gameSession.currentMatch.currentRound.currentBonus?.preamble || '(No preamble)'">
            </div>
          </div>
        </div>

        <!-- PART READING/ANSWER PHASE -->
        <div *ngIf="gameSession.currentMatch.currentRound.roundState === RoundState.BONUS_READING_PART ||
                    gameSession.currentMatch.currentRound.roundState === RoundState.BONUS_AWAITING_ANSWER">

          <!-- Show preamble (read-only) -->
          <div class="bonus-preamble-section completed">
            <h4>Preamble</h4>
            <div class="bonus-preamble" [innerHTML]="gameSession.currentMatch.currentRound.currentBonus?.preamble || '(No preamble)'">
            </div>
          </div>

          <!-- Show current part -->
          <div class="bonus-part current">
            <div class="part-header">
              <span class="part-label">Part {{ gameSession.currentMatch.currentRound.currentBonusPartIndex + 1 }}</span>
              <span *ngIf="gameSession.currentMatch.currentRound.roundState === RoundState.BONUS_AWAITING_ANSWER"
                    class="timer-badge">
                ⏱ {{ bonusCountdown }}s
              </span>
            </div>

            <div class="part-content">
              <div class="part-question">
                <strong>Question:</strong> <span [innerHTML]="getCurrentBonusPart()?.question"></span>
              </div>
            </div>
          </div>

          <!-- Timer Display for bonus -->
          <div *ngIf="gameSession.currentMatch.currentRound.roundState === RoundState.BONUS_AWAITING_ANSWER"
               class="timer-display">
            <p>Bonus time remaining: {{ bonusCountdown }}</p>
          </div>
        </div>

        <!-- BONUS COMPLETED PHASE -->
        <div *ngIf="gameSession.currentMatch.currentRound.roundState === RoundState.BONUS_COMPLETED">
          <div class="bonus-preamble-section completed">
            <h4>Preamble</h4>
            <div class="bonus-preamble" [innerHTML]="gameSession.currentMatch.currentRound.currentBonus?.preamble || '(No preamble)'">
            </div>
          </div>

          <!-- Show all answered parts with results -->
          <div *ngFor="let part of gameSession.currentMatch.currentRound.currentBonus?.bonusParts; let i = index"
               class="bonus-part completed">
            <div class="part-header">
              <span class="part-label">Part {{ i + 1 }}</span>
              <span class="part-result"
                    [class.correct]="gameSession.currentMatch.currentRound.bonusPartAnswers[i]?.correct">
                {{ gameSession.currentMatch.currentRound.bonusPartAnswers[i]?.correct ? '✓ Right (10 pts)' : '✗ Wrong (0 pts)' }}
              </span>
            </div>
            <div class="part-content">
              <div class="part-question">
                <strong>Q:</strong> <span [innerHTML]="part.question"></span>
              </div>
              <div class="part-answer">
                <strong>A:</strong> <span [innerHTML]="part.answer"></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Round completed. Show question and answer -->
      <div *ngIf="gameSession.currentMatch.currentRound.roundState === 'COMPLETED'" class="round-completed-info">
        <h3>Round Completed</h3>
        <p><strong>Question:</strong> <span [innerHTML]="gameSession.currentMatch.currentRound.question"></span></p>
        <p><strong>Answer:</strong> <span [innerHTML]="gameSession.currentMatch.currentRound.answer"></span></p>
      </div>


      <!-- Team list component: Displays a list of teams with their respective scores and buzz statuses -->
      <app-team-list [teams]="gameSession.teamList"
                     [currentBuzz]="gameSession.currentMatch.currentRound.currentBuzz"
                     [currentRound]="gameSession.currentMatch.currentRound"
                     [previousRoundList]="gameSession.currentMatch.previousRounds">
      </app-team-list>
    </mat-card-content>
  </mat-card>
</div>
