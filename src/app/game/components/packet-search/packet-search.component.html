<div class="packet-search-dialog">
  <h2 mat-dialog-title>
    <mat-icon>travel_explore</mat-icon>
    Find or Generate Packet
  </h2>

  <mat-dialog-content>
    <mat-tab-group>
      <!-- Search Existing Packets Tab -->
      <mat-tab label="Search Existing">
        <div class="tab-content">
          <div class="search-container">
            <mat-form-field class="search-field" appearance="outline">
              <mat-icon matPrefix class="search-icon">search</mat-icon>
              <input
                matInput
                type="text"
                [(ngModel)]="searchQuery"
                placeholder="Type to search for packets..."
                (input)="searchPackets()"
                autocomplete="off"
                >
              @if (searchQuery) {
                <button
                  mat-icon-button
                  matSuffix
                  (click)="clearSearch()"
                  aria-label="Clear search"
                  >
                  <mat-icon>close</mat-icon>
                </button>
              }
            </mat-form-field>

            @if (searchQuery && !isSearching) {
              <div class="search-info">
                @if (searchResults.length > 0) {
                  <span>
                    Found {{ searchResults.length }} packet{{ searchResults.length !== 1 ? 's' : '' }}
                  </span>
                }
                @if (searchResults.length === 0 && searchQuery.length >= 2) {
                  <span>
                    No packets found
                  </span>
                }
                @if (searchQuery.length < 2) {
                  <span class="hint">
                    Type at least 2 characters to search
                  </span>
                }
              </div>
            }
          </div>

          <div class="results-container">
            <!-- Loading state -->
            @if (isSearching) {
              <div class="loading-state">
                <mat-spinner diameter="40"></mat-spinner>
                <p>Searching packets...</p>
              </div>
            }

            <!-- Empty state -->
            @if (!searchQuery && !isSearching) {
              <div class="empty-state">
                <mat-icon>inventory_2</mat-icon>
                <p>Search for quiz bowl packets by name</p>
                <span class="hint">Try searching for a tournament name, year, or difficulty</span>
              </div>
            }

            <!-- Results list -->
            @if (searchResults.length > 0 && !isSearching) {
              <div class="search-results">
                @for (packet of searchResults; track packet; let i = $index) {
                  <div
                    class="result-item"
                    (click)="selectPacket(packet)"
                    [class.selected]="packet.id === selectedPacketId"
                    [attr.data-index]="i"
                    >
                    <div class="result-content">
                      <mat-icon class="result-icon">description</mat-icon>
                      <div class="result-details">
                        <div class="result-name">{{ packet.name }}</div>
                        <div class="result-meta">
                          <span class="packet-id">ID: {{ packet.id }}</span>
                        </div>
                      </div>
                    </div>
                    @if (packet.id === selectedPacketId) {
                      <mat-icon class="check-icon">check_circle</mat-icon>
                    }
                  </div>
                }
              </div>
            }

            <!-- No results state -->
            @if (searchResults.length === 0 && searchQuery && !isSearching && searchQuery.length >= 2) {
              <div class="no-results">
                <mat-icon>search_off</mat-icon>
                <p>No packets found matching "{{ searchQuery }}"</p>
                <span class="hint">Try a different search term</span>
              </div>
            }
          </div>
        </div>
      </mat-tab>

      <!-- Generate New Packet Tab -->
      <mat-tab label="Generate with AI">
        <div class="tab-content">
          <div class="generate-container">
            <!-- Form - hidden when generating -->
            @if (!isGenerating) {
              <div class="generate-form">
                <!-- Validation Error Banner -->
                @if (validationError) {
                  <div class="validation-error">
                    <mat-icon>error</mat-icon>
                    <span>{{ validationError }}</span>
                  </div>
                }

                <!-- API Key Field -->
                <mat-form-field class="api-key-field" appearance="outline" floatLabel="always">
                  <mat-label>OpenAI API Key</mat-label>
                  <input
                    matInput
                    [type]="showApiKey ? 'text' : 'password'"
                    [(ngModel)]="apiKey"
                    (ngModelChange)="onApiKeyChange()"
                    (blur)="onApiKeyBlur()"
                    placeholder="sk-..."
                    required
                    autocomplete="off"
                    >
                  <button
                    mat-icon-button
                    matSuffix
                    (click)="toggleApiKeyVisibility()"
                    [attr.aria-label]="'Hide API key'"
                    type="button"
                    >
                    <mat-icon>{{ showApiKey ? 'visibility_off' : 'visibility' }}</mat-icon>
                  </button>
                  <mat-hint>Your OpenAI API key (never shared or stored on server)</mat-hint>
                </mat-form-field>

                <!-- Remember API Key Checkbox -->
                @if (apiKey) {
                  <mat-checkbox
                    class="remember-checkbox"
                    [(ngModel)]="rememberApiKey"
                    (change)="onRememberChange()"
                    >
                    Remember API key (stored locally in browser)
                  </mat-checkbox>
                }

                <!-- Model Dropdown -->
                <mat-form-field class="model-field" appearance="outline" floatLabel="always">
                  <mat-label>Model</mat-label>
                  <mat-select
                    [(ngModel)]="selectedModel"
                    (ngModelChange)="updateParameterVisibility()"
                    [disabled]="isLoadingModels || availableModels.length === 0"
                    required
                    >
                    @for (model of availableModels; track model) {
                      <mat-option [value]="model">{{ model }}</mat-option>
                    }
                  </mat-select>
                  @if (isLoadingModels) {
                    <mat-spinner matSuffix diameter="20"></mat-spinner>
                  }
                  @if (modelLoadError) {
                    <mat-hint class="error-hint">{{ modelLoadError }}</mat-hint>
                  }
                  @if (!isLoadingModels && !modelLoadError && availableModels.length === 0 && apiKey) {
                    <mat-hint>
                      <button
                        mat-button
                        color="primary"
                        (click)="fetchAvailableModels()"
                        type="button"
                        class="fetch-models-btn"
                        >
                        Fetch Models
                      </button>
                    </mat-hint>
                  }
                  @if (!apiKey) {
                    <mat-hint>Enter API key first to load models</mat-hint>
                  }
                </mat-form-field>

                <mat-form-field class="topic-field" appearance="outline" floatLabel="always">
                  <mat-label>Topic</mat-label>
                  <input
                    matInput
                    type="text"
                    [(ngModel)]="generateTopic"
                    placeholder="e.g., Ancient Rome, Organic Chemistry, Jazz Music"
                    required
                    >
                </mat-form-field>
                <mat-form-field class="context-field" appearance="outline" floatLabel="always">
                  <mat-label>Context (Optional)</mat-label>
                  <textarea
                    matInput
                    [(ngModel)]="generateContext"
                    placeholder="e.g., Focus on the Roman Republic, Include chemical reactions, 1920s-1940s era"
                    rows="3"
                  ></textarea>
                </mat-form-field>

                <mat-form-field class="question-count-field" appearance="outline" floatLabel="always">
                  <mat-label>Number of Questions</mat-label>
                  <input
                    matInput
                    type="number"
                    [(ngModel)]="questionCount"
                    placeholder="5"
                    min="1"
                    max="30"
                    required
                    >
                  <mat-hint>Number of tossups to generate (1-30). Default: 5</mat-hint>
                </mat-form-field>

                <mat-checkbox
                  class="generate-bonuses-checkbox"
                  [(ngModel)]="generateBonuses"
                  >
                  Generate bonuses ({{ questionCount }} bonuses will be generated alongside tossups)
                </mat-checkbox>

                <!-- Advanced LLM Parameters -->
                <mat-expansion-panel class="advanced-options">
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      <mat-icon>tune</mat-icon>
                      Advanced Options (LLM Parameters)
                    </mat-panel-title>
                  </mat-expansion-panel-header>

                  <div class="advanced-options-content">
                    <!-- Temperature -->
                    @if (supportsTemperature) {
                      <mat-form-field appearance="outline" floatLabel="always">
                        <mat-label>Temperature</mat-label>
                        <input
                          matInput
                          type="number"
                          [(ngModel)]="temperature"
                          placeholder="1.0"
                          min="0"
                          max="2"
                          step="0.1"
                          >
                        <mat-hint>Controls randomness (0.0 = deterministic, 2.0 = creative). Default: 1.0</mat-hint>
                      </mat-form-field>
                    }

                    <!-- Top P -->
                    @if (supportsTopP) {
                      <mat-form-field appearance="outline" floatLabel="always">
                        <mat-label>Top P</mat-label>
                        <input
                          matInput
                          type="number"
                          [(ngModel)]="topP"
                          placeholder="1.0"
                          min="0"
                          max="1"
                          step="0.1"
                          >
                        <mat-hint>Nucleus sampling for diversity (0.0 = focused, 1.0 = diverse). Default: 1.0</mat-hint>
                      </mat-form-field>
                    }

                    <!-- Frequency Penalty -->
                    @if (supportsFrequencyPenalty) {
                      <mat-form-field appearance="outline" floatLabel="always">
                        <mat-label>Frequency Penalty</mat-label>
                        <input
                          matInput
                          type="number"
                          [(ngModel)]="frequencyPenalty"
                          placeholder="0.0"
                          min="-2"
                          max="2"
                          step="0.1"
                          >
                        <mat-hint>Penalizes repetition (-2.0 to 2.0). Positive = less repetition. Default: 0.0</mat-hint>
                      </mat-form-field>
                    }

                    <!-- Presence Penalty -->
                    @if (supportsPresencePenalty) {
                      <mat-form-field appearance="outline" floatLabel="always">
                        <mat-label>Presence Penalty</mat-label>
                        <input
                          matInput
                          type="number"
                          [(ngModel)]="presencePenalty"
                          placeholder="0.0"
                          min="-2"
                          max="2"
                          step="0.1"
                          >
                        <mat-hint>Penalizes token reuse (-2.0 to 2.0). Positive = new topics. Default: 0.0</mat-hint>
                      </mat-form-field>
                    }
                  </div>
                </mat-expansion-panel>

                <button
                  mat-raised-button
                  color="accent"
                  [disabled]="!generateTopic || !apiKey || !selectedModel"
                  (click)="generateAIPacket()"
                  class="generate-btn"
                  >
                  <mat-icon>auto_awesome</mat-icon>
                  Generate Packet
                </button>
              </div>
            }

            <!-- Generating state -->
            @if (isGenerating) {
              <div class="generating-state">
                <mat-spinner diameter="50"></mat-spinner>
                <p>Generating packet with AI...</p>
                <span class="hint">This may take a minute</span>
              </div>
            }

            <!-- Generated packet preview -->
            @if (generatedPacket && !isGenerating) {
              <div class="generated-packet">
                <div class="packet-preview">
                  <mat-icon class="success-icon">check_circle</mat-icon>
                  <h3>{{ generatedPacket.name }}</h3>
                  <div class="packet-details">
                    <span class="detail-item">
                      <mat-icon>quiz</mat-icon>
                      {{ generatedPacket.tossups.length || 0 }} Tossups
                    </span>
                    @if (generatedPacket.bonuses && generatedPacket.bonuses.length > 0) {
                      <span class="detail-item">
                        <mat-icon>extension</mat-icon>
                        {{ generatedPacket.bonuses.length }} Bonuses
                      </span>
                    }
                    @if (generatedPacket.difficulty) {
                      <span class="detail-item">
                        <mat-icon>signal_cellular_alt</mat-icon>
                        {{ generatedPacket.difficulty }}
                      </span>
                    }
                  </div>
                </div>
                <!-- Tossups Preview -->
                <div class="tossups-preview">
                  <h4 class="preview-title">
                    <mat-icon>visibility</mat-icon>
                    Preview Tossups
                  </h4>
                  <mat-accordion class="tossup-accordion">
                    @for (tossup of generatedPacket.tossups; track tossup; let i = $index) {
                      <mat-expansion-panel>
                        <mat-expansion-panel-header>
                          <mat-panel-title>
                            <span class="tossup-number">Tossup {{ i + 1 }}</span>
                            @if (tossup.tossup?.subcategory) {
                              <span class="tossup-category">
                                {{ tossup.tossup.subcategory.category.name }} - {{ tossup.tossup.subcategory.name }}
                              </span>
                            }
                          </mat-panel-title>
                        </mat-expansion-panel-header>
                        <div class="tossup-content">
                          <div class="content-section">
                            <div class="section-label">
                              <mat-icon>quiz</mat-icon>
                              Question
                            </div>
                            <div class="section-text">{{ tossup.tossup.question }}</div>
                          </div>
                          <div class="content-section">
                            <div class="section-label">
                              <mat-icon>lightbulb</mat-icon>
                              Answer
                            </div>
                            <div class="section-text answer-text">{{ tossup.tossup.answer }}</div>
                          </div>
                        </div>
                      </mat-expansion-panel>
                    }
                  </mat-accordion>
                </div>
                <!-- Bonuses Preview -->
                @if (generatedPacket.bonuses && generatedPacket.bonuses.length > 0) {
                  <div class="bonuses-preview">
                    <h4 class="preview-title">
                      <mat-icon>visibility</mat-icon>
                      Preview Bonuses
                    </h4>
                    <mat-accordion class="bonus-accordion">
                      @for (bonusRel of generatedPacket.bonuses; track bonusRel; let i = $index) {
                        <mat-expansion-panel>
                          <mat-expansion-panel-header>
                            <mat-panel-title>
                              <span class="bonus-number">Bonus {{ i + 1 }}</span>
                              @if (bonusRel.bonus?.subcategory) {
                                <span class="bonus-category">
                                  {{ bonusRel.bonus.subcategory.category.name }} - {{ bonusRel.bonus.subcategory.name }}
                                </span>
                              }
                            </mat-panel-title>
                          </mat-expansion-panel-header>
                          <div class="bonus-content">
                            @if (bonusRel.bonus?.preamble) {
                              <div class="content-section">
                                <div class="section-label">
                                  <mat-icon>description</mat-icon>
                                  Preamble
                                </div>
                                <div class="section-text">{{ bonusRel.bonus.preamble }}</div>
                              </div>
                            }
                            @for (part of bonusRel.bonus?.bonusParts; track part; let partIdx = $index) {
                              <div class="content-section">
                                <div class="section-label">
                                  <mat-icon>{{ ['looks_one', 'looks_two', 'looks_3'][partIdx] || 'circle' }}</mat-icon>
                                  Part {{ partIdx + 1 }}
                                </div>
                                <div class="section-text">
                                  <strong>Q:</strong> {{ part?.question }}<br>
                                  <strong>A:</strong> <span class="answer-text">{{ part?.answer }}</span>
                                </div>
                              </div>
                            }
                          </div>
                        </mat-expansion-panel>
                      }
                    </mat-accordion>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button (click)="close()" class="cancel-btn">
      Cancel
    </button>
    <button
      mat-raised-button
      color="primary"
      [disabled]="!selectedPacketId && !generatedPacket"
      (click)="confirmSelection()"
      class="select-btn"
      >
      <mat-icon>check</mat-icon>
      Use Packet
    </button>
  </mat-dialog-actions>
</div>
