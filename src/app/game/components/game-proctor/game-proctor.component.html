<div class="game-proctor-container">
  <mat-card *ngIf="gameSessionObs | async as gameSession" class="game-proctor">

    <div class="auto-timer-checkbox">
      <mat-checkbox [(ngModel)]="isAutoTimerActive">Auto Timer Activated</mat-checkbox>
    </div>

    <mat-card-title>
      Round {{ gameSession.currentMatch.currentRound.roundNumber }}
    </mat-card-title>
    <mat-card-content>
      <div class="category-row">
        <div class="info-section category-section">
          <span class="info-label">Category:</span>
          <span class="info-value">{{ gameSession.currentMatch.currentRound.category }}</span>
        </div>
        <div class="info-section subcategory-section">
          <span class="info-label">Subcategory:</span>
          <span class="info-value">{{ gameSession.currentMatch.currentRound.subcategory }}</span>
        </div>
      </div>

      <div class="info-section question-section">
        <div class="info-label">Question</div>
        <div class="info-value">{{ gameSession.currentMatch.currentRound.question }}</div>
      </div>

      <div class="info-section answer-section">
        <div class="info-label">Answer</div>
        <div class="info-value">{{ gameSession.currentMatch.currentRound.answer }}</div>
      </div>

      <!-- Buzz Information -->
      <div *ngIf="gameSession.currentMatch.currentRound.currentBuzz" class="active-buzz-info">
        <p>{{ gameStateService.getPlayerNameById(gameSession.currentMatch.currentRound.currentBuzz.playerId) }} (
          {{ gameStateService.getTeamNameById(gameSession.currentMatch.currentRound.currentBuzz.teamId) }})
          has buzzed in
        </p>
      </div>

      <div class="button-container">
        <!-- Finished Reading Button -->
        <button *ngIf="gameSession.currentMatch.currentRound.roundState === RoundState.PROCTOR_READING"
                mat-raised-button
                id="finished-reading-btn"
                (click)="gameStateService.sendFinishedReading()">
          Finished Reading
        </button>

        <!-- Timeout Button -->
        <button *ngIf="gameSession.currentMatch.currentRound.roundState === RoundState.AWAITING_BUZZ"
                mat-raised-button
                id="timeout-btn"
                (click)="gameStateService.sendTimeoutRound()">
          Timeout
        </button>

        <!-- Advance Round Button -->
        <button *ngIf="gameSession.currentMatch.currentRound.roundState === RoundState.COMPLETED"
                mat-raised-button
                id="advance-round-btn"
                (click)="gameStateService.sendAdvanceRound()">
          Advance Round
        </button>

        <!-- Right/Wrong Buttons -->
        <div *ngIf="gameSession.currentMatch.currentRound.roundState === RoundState.AWAITING_ANSWER"
             class="right-wrong-buttons">
          <button mat-raised-button id="right-btn" (click)="gameStateService.sendAnswerCorrect()">Right</button>
          <button mat-raised-button id="wrong-btn" (click)="gameStateService.sendAnswerIncorrect()">Wrong</button>
        </div>

        <!-- Bonus judging - NEW FLOW -->
        <div *ngIf="gameSession.currentMatch.currentRound.roundState === RoundState.BONUS_READING_PREAMBLE ||
                    gameSession.currentMatch.currentRound.roundState === RoundState.BONUS_READING_PART ||
                    gameSession.currentMatch.currentRound.roundState === RoundState.BONUS_AWAITING_ANSWER ||
                    gameSession.currentMatch.currentRound.roundState === RoundState.BONUS_COMPLETED"
             class="bonus-section">

          <!-- Bonus Header -->
          <div class="bonus-header">
            <h3>Bonus for {{ getBonusEligibleTeamName() }}</h3>
            <div class="bonus-score">
              {{ gameStateService.getCurrentRoundBonusPoints() }} / 30 points
            </div>
          </div>

          <!-- PREAMBLE PHASE -->
          <div *ngIf="gameSession.currentMatch.currentRound.roundState === RoundState.BONUS_READING_PREAMBLE">
            <div class="bonus-preamble-section">
              <h4>Preamble</h4>
              <div class="bonus-preamble">
                {{ gameSession.currentMatch.currentRound.currentBonus?.preamble || '(No preamble)' }}
              </div>
            </div>

            <button mat-raised-button
                    color="primary"
                    id="finished-reading-preamble-btn"
                    (click)="gameStateService.sendFinishedReadingBonusPreamble()">
              Finished Reading Preamble
            </button>
          </div>

          <!-- PART READING/ANSWER PHASE -->
          <div *ngIf="gameSession.currentMatch.currentRound.roundState === RoundState.BONUS_READING_PART ||
                      gameSession.currentMatch.currentRound.roundState === RoundState.BONUS_AWAITING_ANSWER">

            <!-- Show preamble (read-only) -->
            <div class="bonus-preamble-section completed">
              <h4>Preamble ✓</h4>
              <div class="bonus-preamble">
                {{ gameSession.currentMatch.currentRound.currentBonus?.preamble || '(No preamble)' }}
              </div>
            </div>

            <!-- Show previously answered parts -->
            <div *ngFor="let part of gameSession.currentMatch.currentRound.currentBonus?.bonusParts; let i = index">
              <div *ngIf="i < gameSession.currentMatch.currentRound.currentBonusPartIndex"
                   class="bonus-part completed">
                <div class="part-header">
                  <span class="part-label">Part {{ i + 1 }} ✓</span>
                  <span class="part-result"
                        [class.correct]="gameSession.currentMatch.currentRound.bonusPartAnswers[i]?.correct">
                    {{ gameSession.currentMatch.currentRound.bonusPartAnswers[i]?.correct ? '✓ Right (10 pts)' : '✗ Wrong (0 pts)' }}
                  </span>
                </div>
                <div class="part-content">
                  <div class="part-question">
                    <strong>Q:</strong> {{ part.bonusPart?.question || part.question }}
                  </div>
                  <div class="part-answer">
                    <strong>A:</strong> {{ part.bonusPart?.answer || part.answer }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Show current part -->
            <div class="bonus-part current">
              <div class="part-header">
                <span class="part-label">Part {{ gameSession.currentMatch.currentRound.currentBonusPartIndex + 1 }}</span>
                <span *ngIf="gameSession.currentMatch.currentRound.roundState === RoundState.BONUS_AWAITING_ANSWER"
                      class="timer-badge">
                  ⏱ {{ bonusCountdown }}s
                </span>
              </div>

              <div class="part-content">
                <div class="part-question">
                  <strong>Q:</strong> {{ getCurrentBonusPart()?.bonusPart?.question || getCurrentBonusPart()?.question }}
                </div>
                <div class="part-answer">
                  <strong>A:</strong> {{ getCurrentBonusPart()?.bonusPart?.answer || getCurrentBonusPart()?.answer }}
                </div>
              </div>

              <!-- Reading phase button -->
              <div *ngIf="gameSession.currentMatch.currentRound.roundState === RoundState.BONUS_READING_PART"
                   class="part-actions">
                <button mat-raised-button
                        color="primary"
                        id="finished-reading-part-btn"
                        (click)="gameStateService.sendFinishedReadingBonusPart()">
                  Finished Reading Part {{ gameSession.currentMatch.currentRound.currentBonusPartIndex + 1 }}
                </button>
              </div>

              <!-- Answer phase buttons -->
              <div *ngIf="gameSession.currentMatch.currentRound.roundState === RoundState.BONUS_AWAITING_ANSWER"
                   class="part-actions">
                <button mat-raised-button
                        color="primary"
                        (click)="sendBonusPartOutcome(gameSession.currentMatch.currentRound.currentBonusPartIndex, true)">
                  <mat-icon>check_circle</mat-icon>
                  Right (10 pts)
                </button>
                <button mat-raised-button
                        color="warn"
                        (click)="sendBonusPartOutcome(gameSession.currentMatch.currentRound.currentBonusPartIndex, false)">
                  <mat-icon>cancel</mat-icon>
                  Wrong (0 pts)
                </button>
                <button mat-raised-button
                        id="timeout-bonus-btn"
                        (click)="gameStateService.sendTimeoutBonusPart()">
                  Timeout
                </button>
              </div>

              <!-- Timer Display -->
              <div *ngIf="isAutoTimerActive && gameSession.currentMatch.currentRound.roundState === RoundState.BONUS_AWAITING_ANSWER"
                   class="timer-display">
                <p>Bonus time remaining: {{ bonusCountdown }}</p>
              </div>
            </div>
          </div>

          <!-- BONUS COMPLETED PHASE -->
          <div *ngIf="gameSession.currentMatch.currentRound.roundState === RoundState.BONUS_COMPLETED">
            <div class="bonus-preamble-section completed">
              <h4>Preamble ✓</h4>
              <div class="bonus-preamble">
                {{ gameSession.currentMatch.currentRound.currentBonus?.preamble || '(No preamble)' }}
              </div>
            </div>

            <!-- Show all answered parts -->
            <div *ngFor="let part of gameSession.currentMatch.currentRound.currentBonus?.bonusParts; let i = index"
                 class="bonus-part completed">
              <div class="part-header">
                <span class="part-label">Part {{ i + 1 }} ✓</span>
                <span class="part-result"
                      [class.correct]="gameSession.currentMatch.currentRound.bonusPartAnswers[i]?.correct">
                  {{ gameSession.currentMatch.currentRound.bonusPartAnswers[i]?.correct ? '✓ Right (10 pts)' : '✗ Wrong (0 pts)' }}
                </span>
              </div>
              <div class="part-content">
                <div class="part-question">
                  <strong>Q:</strong> {{ part.bonusPart?.question || part.question }}
                </div>
                <div class="part-answer">
                  <strong>A:</strong> {{ part.bonusPart?.answer || part.answer }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Timer Display -->
        <div *ngIf="isAutoTimerActive && gameSession.currentMatch.currentRound.roundState === RoundState.AWAITING_BUZZ"
             class="timer-display">
          <p>Time remaining: {{ countdown }}</p>
        </div>


      </div>

      <app-team-list [teams]="gameSession.teamList"
                     [currentBuzz]="gameSession.currentMatch.currentRound.currentBuzz"
                     [currentRound]="gameSession.currentMatch.currentRound"
                     [previousRoundList]="gameSession.currentMatch.previousRounds">
      </app-team-list>

    </mat-card-content>
  </mat-card>
</div>
