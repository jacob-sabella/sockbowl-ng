@if (gameSessionObs | async; as gameSession) {
  <div class="page">
    <!-- HERO -->
    <section class="hero">
      <div class="hero__card">
        <div class="hero__info">
          <div class="info-item">
            <mat-icon>account_circle</mat-icon>
            <span class="info-label">Proctor:</span>
            <span class="info-value">{{ gameSession.gameSettings.proctorType || '—' }}</span>
          </div>
          <div class="info-item">
            <mat-icon>tune</mat-icon>
            <span class="info-label">Mode:</span>
            <span class="info-value">{{ gameSession.gameSettings.gameMode || '—' }}</span>
          </div>
          @if (gameStateService.getCurrentPlayer()) {
            <div class="info-item">
              <mat-icon>person</mat-icon>
              <span class="info-label">Player:</span>
              <span class="info-value">{{ gameStateService.getCurrentPlayer()?.name }}</span>
            </div>
          }
          <div class="info-item join-item">
            <mat-icon>qr_code_2</mat-icon>
            <span class="info-label">Code:</span>
            <span class="info-value code-value">{{ gameSession.joinCode }}</span>
            <button
              type="button"
              mat-icon-button
              aria-label="Copy join code"
              (click)="copyJoinCode(gameSession.joinCode)"
              class="copy-btn"
              >
              <mat-icon>content_copy</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </section>
    <!-- GRID -->
    <section class="grid">
      <!-- Packet -->
      <mat-card class="card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>inventory_2</mat-icon>
            Packet
          </mat-card-title>
          <mat-card-subtitle>Choose a packet to use for this match.</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          @if (gameSession.currentMatch.packet) {
            <div class="kv">
              <div class="kv__row">
                <span class="kv__key">Packet ID: </span>
                <span class="kv__val code">{{ gameSession.currentMatch.packet.id }}</span>
              </div>
              <div class="kv__row">
                <span class="kv__key">Name: </span>
                <span class="kv__val">{{ gameSession.currentMatch.packet.name }}</span>
              </div>
            </div>
            <!-- Bonus Settings -->
            @if (hasPacketBonuses()) {
              <div class="bonus-settings">
                <mat-divider></mat-divider>
                <p class="bonus-info">
                  <mat-icon class="info-icon">info</mat-icon>
                  This packet contains <strong>{{ getBonusCount() }}</strong> bonus questions.
                  Each bonus has 3 parts worth 10 points each.
                </p>
                <mat-slide-toggle
                  [(ngModel)]="bonusesEnabled"
                  (change)="toggleBonuses()"
                  color="primary"
                  class="bonus-toggle">
                  Enable Bonuses
                </mat-slide-toggle>
              </div>
            }
          } @else {
            <div class="empty-state">
              <mat-icon>search</mat-icon>
              <p>No packet selected.</p>
            </div>
          }
        </mat-card-content>
        <mat-card-actions align="end">
          @if (gameStateService.isSelfProctor()) {
            <button mat-raised-button color="primary" (click)="openPacketSearch()">
              <mat-icon>travel_explore</mat-icon>
              Find a Packet
            </button>
          }
        </mat-card-actions>
      </mat-card>
      <!-- Proctor -->
      <mat-card class="card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>supervisor_account</mat-icon>
            Proctor
          </mat-card-title>
          <mat-card-subtitle>Match runner</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="proctor">
            <mat-icon class="proctor__avatar">face</mat-icon>
            <span class="proctor__name">
              {{ gameStateService.getProctor()?.name || 'No proctor yet' }}
            </span>
          </div>
        </mat-card-content>
        <mat-card-actions align="end">
          @if (canBecomeProctor()) {
            <button
              mat-raised-button
              color="primary"
              (click)="becomeProctor()"
              >
              <mat-icon>workspace_premium</mat-icon>
              Become Proctor
            </button>
          }
          @if (gameStateService.isSelfProctor()) {
            <button
              mat-raised-button
              color="primary"
              (click)="startMatch()"
              class="start-game-btn"
              >
              <mat-icon>play_arrow</mat-icon>
              Start Game
            </button>
          }
        </mat-card-actions>
      </mat-card>
      <!-- Teams -->
      <mat-card class="card card--span2">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>groups</mat-icon>
            Teams
          </mat-card-title>
          <mat-card-subtitle>Join a team or switch to spectating.</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="teams">
            @for (team of gameSession.teamList; track trackByTeamId($index, team)) {
              <div
                class="team"
                >
                <div class="team__header">
                  <h3 class="team__name">
                    {{ team.teamName }}
                    <span class="team__count">{{ team.teamPlayers.length || 0 }}</span>
                  </h3>
                </div>
                <div class="team__players">
                  @for (player of team.teamPlayers; track trackByPlayerId($index, player)) {
                    <div
                      class="player"
                      >
                      <mat-icon class="player__avatar">face</mat-icon>
                      <span class="player__name">{{ player.name }}</span>
                    </div>
                  }
                </div>
                <div class="team__actions">
                  @if (!gameStateService.isSelfOnTeam(team.teamId)) {
                    <button
                      mat-stroked-button
                      color="primary"
                      (click)="joinTeam(team)"
                      >
                      <mat-icon>login</mat-icon>
                      Join {{ team.teamName }}
                    </button>
                  }
                </div>
              </div>
            }
          </div>
        </mat-card-content>
      </mat-card>
      <!-- Spectators -->
      <mat-card class="card card--span2">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>visibility</mat-icon>
            Spectators
          </mat-card-title>
          <mat-card-subtitle>People watching the match.</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <mat-list class="spectators">
            @for (player of gameSession.playerList; track trackByPlayerId($index, player)) {
              <mat-list-item
                [style.display]="player.playerMode === PlayerMode.SPECTATOR ? '' : 'none'"
                >
                <mat-icon matListItemIcon>face</mat-icon>
                <div matListItemTitle>{{ player.name }}</div>
              </mat-list-item>
            }
          </mat-list>
        </mat-card-content>
        <mat-card-actions align="end">
          @if (gameStateService.isSelfOnAnyTeam() || gameStateService.isSelfProctor()) {
            <button
              mat-raised-button
              color="primary"
              (click)="switchToSpectate()"
              >
              <mat-icon>visibility</mat-icon>
              Spectate
            </button>
          }
        </mat-card-actions>
      </mat-card>
    </section>
  </div>
}
